<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function($scope,spModal) {
  /* widget controller */
  var c = this;
	
	c.showRejectModal = false;
	c.rejectionSYSID = '';

	c.showConfirmationReject1 = function(sysId) {
		c.rejectReason = "";
		c.showRejectModal = true;
		c.rejectionSYSID = sysId;
	};

	c.closeRejectModal = function() {
		c.showRejectModal = false;
	};

	c.submitRejection = function() {
		// Handle rejection logic
		if(c.rejectReason.length === 0){
			alert('Rejection comments are required');
		}else{
			console.log('Rejection Reason:', c.rejectReason);
			c.rejectRecord(c.rejectionSYSID,c.rejectReason);
			// Close the modal
			c.closeRejectModal();
		}
	};
	
	c.showConfirmationReject = function(sysId) {
				c.rejectReason = "Hard coded reason for rejection!";
        var dialogConfig = {
            header: "Confirmation",
            message: "Are you sure you want to reject this request for renewal of contract?",
            buttons: [{
                label: "Yes",
                primary: true,
                value: "yes"
            }, {
                label: "No",
                primary: false,
                value: "no"
            }],
						input: true
        };
				console.log('Click');
				spModal.open(dialogConfig).then(function(response) {
						console.log('response: ', response);
            if (response.value === 'yes') {
                //c.rejectRecord(sysId,c.rejectReason);
            } else {
                console.log('Renewal approval canceled by the contingent owner.');
            }
        });
				
    };
	
	c.rejectRecord = function (sysId,reasonForRejection) {
				console.log('Reject Renewal called');
				console.log('REASON : ' + reasonForRejection);
				c.data.action = 'rejectRenewContract';
				c.data.reasonForTheRejection = reasonForRejection;
				c.data.sysID = sysId;
				c.server.update().then(function(){
					c.data.action = undefined;
					c.data.sysID = '';
					c.server.refresh();
				})
    };
	
	c.showConfirmation = function(sysId) {
        var dialogConfig = {
            header: "Confirmation",
            message: "Are you sure you want to approve this request for renewal of contract?",
            buttons: [{
                label: "Yes",
                primary: true,
                value: "yes"
            }, {
                label: "No",
                primary: false,
                value: "no"
            }]

        };
				console.log('Click');
				spModal.open(dialogConfig).then(function(response) {
						console.log('RESPONSE ', response);
            if (response.value === 'yes') {
                c.renewRecord(sysId);
            } else {
                console.log('Renewal approval canceled by the contingent owner.');
            }
        });
    };
	c.renewRecord = function (sysId) {
				console.log('Renewal called');
				console.log('Sys_id : ' + sysId);
				c.data.action = 'renewContract';
				c.data.sysID = sysId;
				c.server.update().then(function(){
					c.data.action = undefined;
					c.data.sysID = '';
					c.server.refresh();
				})
    };
};]]></client_script>
        <controller_as>c</controller_as>
        <css>/* Additional styling for the Reject Renewal Modal input */
.custom-modal input {
  width: 80%;
  padding: 12px;
  margin: 8px 0;
  box-sizing: border-box;
  border: 1px solid #ddd;
  border-radius: 4px;
  outline: none;
  transition: border-color 0.3s;
}

.custom-modal input:focus {
  border-color: #3498db; /* Highlight border color on focus, you can change this */
}

.custom-modal button {
  background-color: #e74c3c; /* Red color, you can change this */
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.custom-modal button:hover {
  background-color: #c0392b; /* Darker red color on hover, you can change this */
}

.custom-modal label {
  display: block;
  font-weight: bold;
  margin-bottom: 8px;
}

.custom-modal .modal-content {
  text-align: center;
}

.custom-modal .close {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 20px;
  cursor: pointer;
  color: #555;
}

.custom-modal .close:hover {
  color: #333;
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>approve_renewals_table</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Approve Renewals table</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
	data.records = [];
	data.userID = gs.getUserID();
	data.header = ['Worker Name','Start Date','End Date','Contingent Request Manager','Approve','Reject'];
	
	var gr = new GlideRecord('sn_contingent_mgmt_contract_worker');
	gr.addQuery('contract_owner.owner_name', gs.getUserID());
	gr.addQuery('isrenewalrequested','requested');
	gr.query();
	console.log('Hwllo');
	while (gr.next()) {
		var record = {
			workerName: gr.worker_name.getDisplayValue(),
			startDate: gr.start_date.getDisplayValue(),
			endDate: gr.end_date.getDisplayValue(),
			manager: gr.contingent_request_manager.getDisplayValue(),
			sys_id: gr.getUniqueValue()
		};
		console.log('Record');
		data.records.push(record);
	}
	
	if(input){
		if(input.action == 'renewContract'){
				var sysID = input.sysID;
				gs.info('Update called, sysID : ' + sysID);
				var gr1 = new GlideRecord('sn_contingent_mgmt_contract_worker');
				if(gr1.get(sysID)){
					
						var valueOfEndDate = gr1.getValue('end_date');
						var currentDateStr = valueOfEndDate;
						var currentDate = new Date(currentDateStr.replace(/-/g, '/'));

						// Check if currentDate is a valid Date object
						if (!isNaN(currentDate.getTime())) {
								// Create a new Date object for 30 days after the current date
								var nextDate = new Date(currentDate);
								gs.info('Current End Date : ' + valueOfEndDate);
								nextDate.setDate(currentDate.getDate() + 31);

								// 'nextDate' now contains the date and time 30 days after 'currentDate'
								var formattedDateStr = nextDate.toISOString().replace(/T/, ' ').replace(/\..+/, '');
								gs.info("Next date: " + nextDate);
								gs.info("Formated next date: " + formattedDateStr);
								gr1.setValue('end_date',formattedDateStr);
								gr1.isrenewalrequested = 'approved';
								gr1.update();
							
								var gr2 = new GlideRecord('sn_contingent_mgmt_contingent_request');
								var contingentReqSysID = gr1.contingent_request;
								gs.info('Contingent Request SysID ' + contingentReqSysID);
								gr2.addQuery('sys_id',contingentReqSysID);
								gr2.query();
								if(gr2.next()){
									gr2.end_date = formattedDateStr;
									gr2.update();
									gs.info('Contingent Request UPDATED');
								}
								
								// var newEndDate = new Date(formattedDateStr);
								// gs.info('Updating new end date : ' + newEndDate);
						} else {
								gs.info("Next date: " + "error");
						}
					
					  
				}
				gs.info('Update done');
			}
			if(input.action == 'rejectRenewContract'){
				var rejectsysID = input.sysID;
				console.log('REJECTION REASEON ' + data.reasonForTheRejection);
				var gr3 = new GlideRecord('sn_contingent_mgmt_contract_worker');
				if(gr3.get(rejectsysID)){
					gr3.isrenewalrequested = 'rejected';
					
					gr3.rejection_comments = input.reasonForTheRejection;
					gr3.update();
				}
			}
	}
	
})();

















]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2024-01-15 11:09:15</sys_created_on>
        <sys_id>b7bbbd70933bf51098002763b18918d1</sys_id>
        <sys_mod_count>80</sys_mod_count>
        <sys_name>Approve Renewals table</sys_name>
        <sys_package display_value="Contingent Mgmt Application" source="sn_contingent_mgmt">a573ef1c9313f11098002763b18918b2</sys_package>
        <sys_policy/>
        <sys_scope display_value="Contingent Mgmt Application">a573ef1c9313f11098002763b18918b2</sys_scope>
        <sys_update_name>sp_widget_b7bbbd70933bf51098002763b18918d1</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2024-01-16 09:46:11</sys_updated_on>
        <template><![CDATA[<div>
  <h1>Renewals Approval Page</h1>
  	<hr>
  	<p>Dear contingent owner,</p>
  	<p>The following are the list of contracts that are requested for renewal by the hiring manager. Approve or reject the contracts as required.</p>
  
  <table id="contingentWorkerTable" class="table">
        <thead>
            <tr>
                <th ng-repeat="col in data.header">{{col}}</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="record in data.records">
                <td>{{record.workerName}}</td>
                <td>{{record.startDate}}</td>
                <td>{{record.endDate}}</td>
                <td>{{record.manager}}</td>
	              <td><button class="renew-button"ng-click="c.showConfirmation(record.sys_id)">Approve Renewal</button></td>
              	<td><button class="renew-button"ng-click="c.showConfirmationReject1(record.sys_id)">Reject Renewal</button></td>
            </tr>
        </tbody>
    </table>
  <div id="rejectRenewalModal" class="custom-modal" ng-show="c.showRejectModal">
    <div class="modal-content">
      <span class="close" ng-click="c.closeRejectModal()">&times;</span>
      <label for="rejectionReason">Reason for Rejection:</label>
      <input type="text" id="rejectionReason" ng-model="c.rejectReason">
      <br>
      <button ng-click="c.submitRejection()">Submit Rejection</button>
    </div>
  </div>
  
</div>
]]></template>
    </sp_widget>
</record_update>
